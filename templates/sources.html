{% extends "base.html" %}

{% block title %}Sources - {{ title }}{% endblock %}

{% block content %}
<div class="sources-page">
    <div class="page-header">
        <h1>Submit Learning Material</h1>
        <p class="page-subtitle">Transform any content into interactive quizzes with intelligent question generation</p>
    </div>
    
    <!-- Submit Source Form -->
    <div class="card">
        <form id="source-form" enctype="multipart/form-data">
            <!-- Source Type Selection Cards -->
            <div class="form-group">
                <label class="form-label">Submit Learning Material</label>
                <div class="source-type-cards">
                    <div class="source-type-card" data-type="url" id="source-type-card-url">
                        <div class="source-type-icon">üîó</div>
                        <div class="source-type-label">URL / Webpage</div>
                    </div>
                    <div class="source-type-card" data-type="pdf" id="source-type-card-pdf">
                        <div class="source-type-icon">üìÑ</div>
                        <div class="source-type-label">PDF Document</div>
                    </div>
                    <div class="source-type-card" data-type="word" id="source-type-card-word">
                        <div class="source-type-icon">üìù</div>
                        <div class="source-type-label">Word Document</div>
                    </div>
                    <div class="source-type-card" data-type="image" id="source-type-card-image">
                        <div class="source-type-icon">üñºÔ∏è</div>
                        <div class="source-type-label">Image (OCR)</div>
                    </div>
                </div>
                <input type="hidden" id="source-type" name="type" required>
            </div>
            
            <!-- Topic Input (Optional) -->
            <div class="form-group">
                <label class="form-label">Topic (optional)</label>
                <input type="text" id="topic-input" name="topic" placeholder="e.g., Machine Learning, Web Development..." class="form-input">
                <p class="form-helper-text">Leave blank to auto-detect topic from content</p>
            </div>
            
            <!-- URL Input -->
            <div id="url-input" class="form-group" style="display: none;">
                <label class="form-label">Enter URL</label>
                <input type="url" name="url" placeholder="https://example.com/article" class="form-input">
                <p class="form-helper-text">Supports JavaScript-rendered pages</p>
            </div>
            
            <!-- File Input -->
            <div id="file-input" class="form-group" style="display: none;">
                <label class="form-label">Upload File</label>
                <div id="file-drop-zone" class="file-drop-zone">
                    <div class="file-drop-content">
                        <div class="file-drop-icon">üìÅ</div>
                        <p class="file-drop-text">Drag and drop your file here</p>
                        <p class="file-drop-subtext">or click to browse</p>
                        <input type="file" id="file-input-field" name="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.gif" style="display: none;">
                        <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('file-input-field').click()">Choose File</button>
                    </div>
                    <div id="file-preview" class="file-preview" style="display: none;">
                        <div class="file-preview-content">
                            <span class="file-preview-icon">üìÑ</span>
                            <span class="file-preview-name" id="file-preview-name"></span>
                            <button type="button" class="file-preview-remove" onclick="clearFileSelection()" title="Remove file">√ó</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-large" style="width: 100%; margin-top: 1.5rem;">Generate Quiz Questions</button>
        </form>
    </div>
    
    <!-- Question Preview Section (shown after generation) -->
    <div id="question-preview-section" class="card" style="display: none;">
        <div class="card-header">
            <h2 class="card-title">Generated Questions Preview</h2>
            <button type="button" id="show-correct-answers-btn" class="btn btn-secondary btn-small">Show Correct Answers</button>
        </div>
        <div id="question-preview-content"></div>
    </div>
    
    <!-- Sources List -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Your Sources</h2>
        </div>
        <div id="sources-list">
            <div class="loading-state">
                <div class="spinner"></div>
                <p class="loading-state-text">Loading sources...</p>
            </div>
        </div>
    </div>
    
    <!-- How It Works Section -->
    <div class="info-section how-it-works-section">
        <h2>How It Works</h2>
        <ol class="how-it-works-list">
            <li>Submit your learning material from any supported source</li>
            <li>AI analyzes the content and generates 5 multiple-choice questions</li>
            <li>Review and select questions to create your quiz</li>
            <li>Take the quiz and get instant feedback</li>
        </ol>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_BASE = '/api/v1';

// Source type card selection
const sourceTypeCards = document.querySelectorAll('.source-type-card');
const sourceTypeInput = document.getElementById('source-type');

sourceTypeCards.forEach(card => {
    card.addEventListener('click', function() {
        // Remove active class from all cards
        sourceTypeCards.forEach(c => c.classList.remove('active'));
        // Add active class to clicked card
        this.classList.add('active');
        // Set the hidden input value
        const type = this.dataset.type;
        sourceTypeInput.value = type;
        
        // Show/hide appropriate inputs
    document.getElementById('url-input').style.display = type === 'url' ? 'block' : 'none';
    const fileInputDiv = document.getElementById('file-input');
    fileInputDiv.style.display = ['pdf', 'word', 'image'].includes(type) ? 'block' : 'none';
    
    // Clear file selection when switching types
    if (!['pdf', 'word', 'image'].includes(type)) {
        clearFileSelection();
    }
    });
});

// File selection handlers (defined before use)
function handleFileSelection(file) {
    if (file) {
        // Show preview
        document.getElementById('file-preview-name').textContent = file.name;
        document.getElementById('file-preview').style.display = 'block';
        document.querySelector('.file-drop-content').style.display = 'none';
    }
}

function clearFileSelection() {
    const fileInput = document.getElementById('file-input-field');
    if (fileInput) {
        fileInput.value = '';
    }
    const preview = document.getElementById('file-preview');
    const content = document.querySelector('.file-drop-content');
    if (preview) preview.style.display = 'none';
    if (content) content.style.display = 'flex';
}

// File input change handler
const fileInputField = document.getElementById('file-input-field');
if (fileInputField) {
    fileInputField.addEventListener('change', function(e) {
        handleFileSelection(e.target.files[0]);
    });
}

// Drag and drop functionality
const dropZone = document.getElementById('file-drop-zone');
const fileInput = document.getElementById('file-input-field');

if (dropZone && fileInput) {
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Highlight drop zone when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('drag-over');
    }

    function unhighlight(e) {
        dropZone.classList.remove('drag-over');
    }

    // Handle dropped files
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            const file = files[0];
            // Check if file type is allowed
            const allowedTypes = ['.pdf', '.doc', '.docx', '.png', '.jpg', '.jpeg', '.gif'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (allowedTypes.includes(fileExtension)) {
                // Set the file to the input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                handleFileSelection(file);
            } else {
                alert(`File type not allowed. Allowed types: ${allowedTypes.join(', ')}`);
            }
        }
    }
    
    dropZone.addEventListener('drop', handleDrop, false);
}

// Make functions available globally for onclick handlers
window.handleFileSelection = handleFileSelection;
window.clearFileSelection = clearFileSelection;

// Submit source form
document.getElementById('source-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const type = sourceTypeInput.value || formData.get('type');
    
    // Debug: log form data
    console.log('Form data:', {
        type: type,
        url: formData.get('url'),
        file: formData.get('file') ? 'File selected' : 'No file'
    });
    
    // Validate before submitting
    if (!type) {
        alert('Please select a source type by clicking on one of the cards above');
        return;
    }
    
    // Ensure type is in formData
    if (!formData.get('type')) {
        formData.set('type', type);
    }
    
    if (type === 'url' && !formData.get('url')) {
        alert('Please enter a URL');
        return;
    }
    
           if (['pdf', 'word', 'image'].includes(type)) {
               const fileInput = document.getElementById('file-input-field');
               if (!fileInput.files || fileInput.files.length === 0) {
                   alert('Please select a file');
                   return;
               }
               // Ensure the file is in the form data
               formData.append('file', fileInput.files[0]);
           }
    
    try {
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        
        // Don't set Content-Type header - let fetch set it automatically for FormData
        const response = await fetch(`${API_BASE}/sources`, {
            method: 'POST',
            body: formData
            // Note: Don't set Content-Type header - fetch will set it with boundary
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Source submitted successfully!');
            this.reset();
            // Clear card selection
            sourceTypeCards.forEach(c => c.classList.remove('active'));
            sourceTypeInput.value = '';
            document.getElementById('url-input').style.display = 'none';
            document.getElementById('file-input').style.display = 'none';
            clearFileSelection();
            loadSources();
        } else {
            let errorMsg = data.error || 'Unknown error';
            if (data.debug) {
                console.error('Debug info:', data.debug);
                errorMsg += '\n\nDebug: Check console for details';
            }
            alert('Error: ' + errorMsg);
        }
    } catch (error) {
        console.error('Error submitting source:', error);
        alert('Error submitting source: ' + error.message);
    } finally {
        // Restore button state
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Generate Quiz Questions';
        }
    }
});

// Load sources
async function loadSources() {
    try {
        const response = await fetch(`${API_BASE}/sources`);
        const data = await response.json();
        
        if (data.success) {
            const sourcesList = document.getElementById('sources-list');
            if (data.data.length === 0) {
                sourcesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p class="empty-state-text">No sources yet</p>
                        <p class="empty-state-subtext">Submit a source above to get started!</p>
                    </div>
                `;
                return;
            }
            
            // Get topics for each source to show status
            const sourcesWithTopics = await Promise.all(data.data.map(async (source) => {
                try {
                    const topicsRes = await fetch(`${API_BASE}/sources/${source.id}/topics`);
                    const topicsData = await topicsRes.json();
                    const topics = topicsData.success ? topicsData.data : [];
                    const totalQuestions = topics.reduce((sum, topic) => sum + (topic.questions?.length || 0), 0);
                    return { ...source, topics, totalQuestions };
                } catch (e) {
                    return { ...source, topics: [], totalQuestions: 0 };
                }
            }));
            
            sourcesList.innerHTML = sourcesWithTopics.map(source => {
                const hasTopics = source.topics && source.topics.length > 0;
                const buttonText = hasTopics 
                    ? `Generate More Questions (${source.topics.length} topic${source.topics.length !== 1 ? 's' : ''}, ${source.totalQuestions} questions)`
                    : 'Generate Topic & Questions';
                const buttonClass = hasTopics ? 'btn btn-primary' : 'btn btn-success';
                
                // Format source display name
                let sourceDisplayName = source.title;
                let sourceContentDisplay = source.content;
                
                // For URLs, extract domain name and show full URL
                if (source.type === 'url') {
                    try {
                        const url = new URL(source.content);
                        sourceDisplayName = url.hostname.replace('www.', '');
                        sourceContentDisplay = source.content;
                    } catch (e) {
                        sourceDisplayName = source.title;
                        sourceContentDisplay = source.content;
                    }
                } else if (source.content.length > 200) {
                    sourceContentDisplay = source.content.substring(0, 200) + '...';
                }
                
                // Format type display
                const typeLabels = {
                    'url': 'URL',
                    'pdf': 'PDF Document',
                    'word': 'Word Document',
                    'image': 'Image (OCR)'
                };
                const typeLabel = typeLabels[source.type] || source.type;
                
                return `
                <div class="source-item" id="source-${source.id}">
                    <div class="source-header">
                        <h3 class="source-title">${sourceDisplayName}</h3>
                        <button onclick="deleteSource(${source.id})" class="btn btn-danger btn-small">Delete</button>
                    </div>
                    <div class="source-details">
                        <p class="source-detail-item"><strong>Type:</strong> <span class="source-type-badge">${typeLabel}</span></p>
                        <p class="source-detail-item"><strong>Content:</strong> <span class="source-content">${sourceContentDisplay}</span></p>
                    </div>
                    ${hasTopics ? `
                        <div class="source-status">
                            <span class="status-checkmark">‚úì</span>
                            <span class="status-text">${source.topics.length} topic${source.topics.length !== 1 ? 's' : ''} with ${source.totalQuestions} question${source.totalQuestions !== 1 ? 's' : ''} generated</span>
                        </div>
                    ` : ''}
                    <div class="source-actions">
                        <button onclick="generateTopic(${source.id})" id="generate-btn-${source.id}" class="${buttonClass}">${buttonText}</button>
                        <button onclick="viewTopics(${source.id})" class="btn btn-secondary">View Topics</button>
                    </div>
                    <div id="loading-${source.id}" class="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <span class="loading-text">Generating questions... This may take a moment.</span>
                    </div>
                </div>
            `;
            }).join('');
        }
    } catch (error) {
        document.getElementById('sources-list').innerHTML = '<p>Error loading sources</p>';
    }
}

async function generateTopic(sourceId) {
    // Get elements
    const generateBtn = document.getElementById(`generate-btn-${sourceId}`);
    const loadingIndicator = document.getElementById(`loading-${sourceId}`);
    const sourceItem = document.getElementById(`source-${sourceId}`);
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.textContent = 'Generating...';
    loadingIndicator.style.display = 'flex';
    sourceItem.classList.add('generating');
    loadingIndicator.querySelector('.loading-text').textContent = 'Analyzing content and generating topic name...';
    
    try {
        // AI will auto-generate topic name - no user input needed
        const response = await fetch(`${API_BASE}/sources/${sourceId}/generate-topic`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({}) // Empty - AI will generate topic name
        });
        
        const data = await response.json();
        if (data.success) {
            // Update loading text to show success
            loadingIndicator.querySelector('.loading-text').textContent = `‚úÖ Successfully created topic with ${data.data.questions.length} questions!`;
            loadingIndicator.classList.add('success');
            
            // Show question preview
            showQuestionPreview(data.data);
            
            // Reload sources after a brief delay
            setTimeout(() => {
                loadSources();
            }, 1500);
        } else {
            // Show error
            loadingIndicator.querySelector('.loading-text').textContent = `‚ùå Error: ${data.error}`;
            loadingIndicator.classList.add('error');
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Topic & Questions';
            
            // Hide error after 5 seconds
            setTimeout(() => {
                loadingIndicator.style.display = 'none';
                loadingIndicator.classList.remove('error');
            }, 5000);
        }
    } catch (error) {
        // Show error
        loadingIndicator.querySelector('.loading-text').textContent = `‚ùå Error: ${error.message}`;
        loadingIndicator.classList.add('error');
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Topic & Questions';
        
        // Hide error after 5 seconds
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
            loadingIndicator.classList.remove('error');
        }, 5000);
    } finally {
        // Remove generating class
        sourceItem.classList.remove('generating');
    }
}

async function viewTopics(sourceId) {
    try {
        const response = await fetch(`${API_BASE}/sources/${sourceId}/topics`);
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
            // Create modal backdrop
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'topics-modal';
            
            // Build topics HTML
            const topicsHtml = data.data.map(topic => `
                <div class="modal-topic-item">
                    <div class="modal-topic-header">
                        <h4 class="modal-topic-title">${topic.title}</h4>
                        <span class="modal-topic-count">${topic.questions.length} question${topic.questions.length !== 1 ? 's' : ''}</span>
                    </div>
                    ${topic.description ? `<p class="modal-topic-description">${topic.description}</p>` : ''}
                    <button onclick="createQuizFromTopic(${topic.id}); closeTopicsModal();" class="btn btn-primary btn-small">Create Quiz</button>
                </div>
            `).join('');
            
            // Create modal content
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h2 class="modal-title">Topics</h2>
                        <button class="modal-close" onclick="closeTopicsModal()" aria-label="Close">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${topicsHtml}
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeTopicsModal()" class="btn btn-primary">OK</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeTopicsModal();
                }
            });
            
            // Close on Escape key
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    closeTopicsModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        } else {
            // Show empty state modal
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'topics-modal';
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h2 class="modal-title">Topics</h2>
                        <button class="modal-close" onclick="closeTopicsModal()" aria-label="Close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-empty-state">
                            <p>No topics found for this source.</p>
                            <p class="modal-empty-subtext">Generate questions first to create topics.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeTopicsModal()" class="btn btn-primary">OK</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeTopicsModal();
                }
            });
        }
    } catch (error) {
        alert('Error loading topics: ' + error.message);
    }
}

function closeTopicsModal() {
    const modal = document.getElementById('topics-modal');
    if (modal) {
        modal.remove();
    }
}

function createQuizFromTopic(topicId) {
    window.location.href = `/quizzes?topic_id=${topicId}`;
}

// Make functions available globally
window.createQuizFromTopic = createQuizFromTopic;
window.closeTopicsModal = closeTopicsModal;

async function deleteSource(sourceId) {
    if (!confirm('Are you sure you want to delete this source? This will also delete all associated topics and questions.')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/sources/${sourceId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Source deleted successfully!');
            loadSources();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete source'));
        }
    } catch (error) {
        console.error('Error deleting source:', error);
        alert('Error deleting source: ' + error.message);
    }
}

// Show question preview after generation
function showQuestionPreview(topicData) {
    const previewSection = document.getElementById('question-preview-section');
    const previewContent = document.getElementById('question-preview-content');
    
    if (!topicData.questions || topicData.questions.length === 0) {
        return;
    }
    
    let html = `
        <div style="margin-bottom: 1.5rem;">
            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">${topicData.title}</h3>
            ${topicData.description ? `<p style="color: var(--text-secondary); margin-bottom: 1rem;">${topicData.description}</p>` : ''}
            <p style="color: var(--text-secondary); font-size: 0.875rem;">${topicData.questions.length} question${topicData.questions.length !== 1 ? 's' : ''} generated</p>
        </div>
    `;
    
    topicData.questions.forEach((question, qIdx) => {
        html += `
            <div class="question-preview-card" data-question-id="${question.id}">
                <div class="question-preview-header">
                    <h4>Question ${qIdx + 1}</h4>
                </div>
                <div class="question-preview-text">${question.question_text}</div>
                <div class="question-preview-answers">
                    ${question.answers.map((answer, aIdx) => `
                        <div class="answer-preview-option" data-answer-id="${aIdx}" data-is-correct="${answer.is_correct}">
                            <input type="checkbox" id="preview-q${question.id}-a${aIdx}" disabled>
                            <label for="preview-q${question.id}-a${aIdx}">
                                ${answer.text}
                                <span class="answer-points">${answer.points > 0 ? '+' : ''}${answer.points} pts</span>
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    previewContent.innerHTML = html;
    previewSection.style.display = 'block';
    
    // Attach show correct answers handler
    attachShowCorrectAnswersHandler();
    
    // Scroll to preview section
    previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Show correct answers button handler (attach after DOM is ready)
function attachShowCorrectAnswersHandler() {
    const showCorrectBtn = document.getElementById('show-correct-answers-btn');
    if (showCorrectBtn) {
        // Remove existing listeners if any
        const newBtn = showCorrectBtn.cloneNode(true);
        showCorrectBtn.parentNode.replaceChild(newBtn, showCorrectBtn);
        
        // Attach new listener
        document.getElementById('show-correct-answers-btn').addEventListener('click', function() {
            const isShowing = this.dataset.showing === 'true';
            
            if (isShowing) {
                // Hide correct answers
                document.querySelectorAll('.answer-preview-option input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.querySelectorAll('.answer-preview-option').forEach(option => {
                    option.classList.remove('correct-answer-highlight');
                });
                this.textContent = 'Show Correct Answers';
                this.dataset.showing = 'false';
            } else {
                // Show correct answers by pre-selecting them
                document.querySelectorAll('.answer-preview-option').forEach(option => {
                    const isCorrect = option.dataset.isCorrect === 'true';
                    const checkbox = option.querySelector('input[type="checkbox"]');
                    if (isCorrect) {
                        checkbox.checked = true;
                        option.classList.add('correct-answer-highlight');
                    }
                });
                this.textContent = 'Hide Correct Answers';
                this.dataset.showing = 'true';
            }
        });
    }
}

// Load sources on page load
loadSources();
</script>
{% endblock %}

