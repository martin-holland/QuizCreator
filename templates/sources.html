{% extends "base.html" %}

{% block title %}Sources - {{ title }}{% endblock %}

{% block content %}
<div class="sources-page">
    <div class="page-header">
        <h1>Sources</h1>
        <p class="page-subtitle">Add content sources to generate quiz questions from</p>
    </div>
    
    <!-- Submit Source Form -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Add New Source</h2>
        </div>
        <form id="source-form" enctype="multipart/form-data">
            <div class="form-group">
                <label>Source Type:</label>
                <select id="source-type" name="type" required>
                    <option value="">Select type...</option>
                    <option value="url">URL</option>
                    <option value="pdf">PDF Document</option>
                    <option value="word">Word Document</option>
                    <option value="image">Image (OCR)</option>
                </select>
            </div>
            
            <div id="url-input" class="form-group" style="display: none;">
                <label>URL:</label>
                <input type="url" name="url" placeholder="https://example.com/article">
            </div>
            
            <div id="file-input" class="form-group" style="display: none;">
                <label>File:</label>
                <div id="file-drop-zone" class="file-drop-zone">
                    <div class="file-drop-content">
                        <div class="file-drop-icon">üìÅ</div>
                        <p class="file-drop-text">Drag and drop your file here</p>
                        <p class="file-drop-subtext">or click to browse</p>
                        <input type="file" id="file-input-field" name="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.gif" style="display: none;">
                        <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('file-input-field').click()">Choose File</button>
                    </div>
                    <div id="file-preview" class="file-preview" style="display: none;">
                        <div class="file-preview-content">
                            <span class="file-preview-icon">üìÑ</span>
                            <span class="file-preview-name" id="file-preview-name"></span>
                            <button type="button" class="file-preview-remove" onclick="clearFileSelection()" title="Remove file">√ó</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Submit Source</button>
        </form>
    </div>
    
    <!-- Sources List -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Your Sources</h2>
        </div>
        <div id="sources-list">
            <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading sources...</p>
        </div>
    </div>
</div>

{% block scripts %}
<script>
const API_BASE = '/api/v1';

// Show/hide inputs based on source type
document.getElementById('source-type').addEventListener('change', function() {
    const type = this.value;
    document.getElementById('url-input').style.display = type === 'url' ? 'block' : 'none';
    const fileInputDiv = document.getElementById('file-input');
    fileInputDiv.style.display = ['pdf', 'word', 'image'].includes(type) ? 'block' : 'none';
    
    // Clear file selection when switching types
    if (!['pdf', 'word', 'image'].includes(type)) {
        clearFileSelection();
    }
});

// File selection handlers (defined before use)
function handleFileSelection(file) {
    if (file) {
        // Show preview
        document.getElementById('file-preview-name').textContent = file.name;
        document.getElementById('file-preview').style.display = 'block';
        document.querySelector('.file-drop-content').style.display = 'none';
    }
}

function clearFileSelection() {
    const fileInput = document.getElementById('file-input-field');
    if (fileInput) {
        fileInput.value = '';
    }
    const preview = document.getElementById('file-preview');
    const content = document.querySelector('.file-drop-content');
    if (preview) preview.style.display = 'none';
    if (content) content.style.display = 'flex';
}

// File input change handler
const fileInputField = document.getElementById('file-input-field');
if (fileInputField) {
    fileInputField.addEventListener('change', function(e) {
        handleFileSelection(e.target.files[0]);
    });
}

// Drag and drop functionality
const dropZone = document.getElementById('file-drop-zone');
const fileInput = document.getElementById('file-input-field');

if (dropZone && fileInput) {
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Highlight drop zone when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('drag-over');
    }

    function unhighlight(e) {
        dropZone.classList.remove('drag-over');
    }

    // Handle dropped files
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            const file = files[0];
            // Check if file type is allowed
            const allowedTypes = ['.pdf', '.doc', '.docx', '.png', '.jpg', '.jpeg', '.gif'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (allowedTypes.includes(fileExtension)) {
                // Set the file to the input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                handleFileSelection(file);
            } else {
                alert(`File type not allowed. Allowed types: ${allowedTypes.join(', ')}`);
            }
        }
    }
    
    dropZone.addEventListener('drop', handleDrop, false);
}

// Make functions available globally for onclick handlers
window.handleFileSelection = handleFileSelection;
window.clearFileSelection = clearFileSelection;

// Submit source form
document.getElementById('source-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const type = formData.get('type');
    
    // Debug: log form data
    console.log('Form data:', {
        type: formData.get('type'),
        url: formData.get('url'),
        file: formData.get('file') ? 'File selected' : 'No file'
    });
    
    // Validate before submitting
    if (!type) {
        alert('Please select a source type');
        return;
    }
    
    if (type === 'url' && !formData.get('url')) {
        alert('Please enter a URL');
        return;
    }
    
           if (['pdf', 'word', 'image'].includes(type)) {
               const fileInput = document.getElementById('file-input-field');
               if (!fileInput.files || fileInput.files.length === 0) {
                   alert('Please select a file');
                   return;
               }
               // Ensure the file is in the form data
               formData.append('file', fileInput.files[0]);
           }
    
    try {
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        
        // Don't set Content-Type header - let fetch set it automatically for FormData
        const response = await fetch(`${API_BASE}/sources`, {
            method: 'POST',
            body: formData
            // Note: Don't set Content-Type header - fetch will set it with boundary
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Source submitted successfully!');
            this.reset();
            document.getElementById('url-input').style.display = 'none';
            document.getElementById('file-input').style.display = 'none';
            loadSources();
        } else {
            let errorMsg = data.error || 'Unknown error';
            if (data.debug) {
                console.error('Debug info:', data.debug);
                errorMsg += '\n\nDebug: Check console for details';
            }
            alert('Error: ' + errorMsg);
        }
    } catch (error) {
        console.error('Error submitting source:', error);
        alert('Error submitting source: ' + error.message);
    } finally {
        // Restore button state
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Source';
        }
    }
});

// Load sources
async function loadSources() {
    try {
        const response = await fetch(`${API_BASE}/sources`);
        const data = await response.json();
        
        if (data.success) {
            const sourcesList = document.getElementById('sources-list');
            if (data.data.length === 0) {
                sourcesList.innerHTML = '<p>No sources yet. Submit one above!</p>';
                return;
            }
            
            // Get topics for each source to show status
            const sourcesWithTopics = await Promise.all(data.data.map(async (source) => {
                try {
                    const topicsRes = await fetch(`${API_BASE}/sources/${source.id}/topics`);
                    const topicsData = await topicsRes.json();
                    const topics = topicsData.success ? topicsData.data : [];
                    const totalQuestions = topics.reduce((sum, topic) => sum + (topic.questions?.length || 0), 0);
                    return { ...source, topics, totalQuestions };
                } catch (e) {
                    return { ...source, topics: [], totalQuestions: 0 };
                }
            }));
            
            sourcesList.innerHTML = sourcesWithTopics.map(source => {
                const hasTopics = source.topics && source.topics.length > 0;
                const buttonText = hasTopics 
                    ? `Generate More Questions (${source.topics.length} topic${source.topics.length !== 1 ? 's' : ''}, ${source.totalQuestions} questions)`
                    : 'Generate Topic & Questions';
                const buttonClass = hasTopics ? 'btn btn-primary' : 'btn btn-success';
                
                return `
                <div class="source-item" id="source-${source.id}">
                    <div class="source-header">
                        <h3>${source.title}</h3>
                        <button onclick="deleteSource(${source.id})" class="btn btn-danger btn-small">Delete</button>
                    </div>
                    <p><strong>Type:</strong> ${source.type}</p>
                    <p><strong>Content:</strong> ${source.content.substring(0, 200)}${source.content.length > 200 ? '...' : ''}</p>
                    ${hasTopics ? `<p style="color: var(--success-color); font-weight: 500; margin-top: 0.5rem;">‚úì ${source.topics.length} topic${source.topics.length !== 1 ? 's' : ''} with ${source.totalQuestions} question${source.totalQuestions !== 1 ? 's' : ''} generated</p>` : ''}
                    <div class="source-actions">
                        <button onclick="generateTopic(${source.id})" id="generate-btn-${source.id}" class="${buttonClass}">${buttonText}</button>
                        <button onclick="viewTopics(${source.id})" class="btn btn-secondary">View Topics</button>
                    </div>
                    <div id="loading-${source.id}" class="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <span class="loading-text">Generating questions... This may take a moment.</span>
                    </div>
                </div>
            `;
            }).join('');
        }
    } catch (error) {
        document.getElementById('sources-list').innerHTML = '<p>Error loading sources</p>';
    }
}

async function generateTopic(sourceId) {
    // Get elements
    const generateBtn = document.getElementById(`generate-btn-${sourceId}`);
    const loadingIndicator = document.getElementById(`loading-${sourceId}`);
    const sourceItem = document.getElementById(`source-${sourceId}`);
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.textContent = 'Generating...';
    loadingIndicator.style.display = 'flex';
    sourceItem.classList.add('generating');
    loadingIndicator.querySelector('.loading-text').textContent = 'Analyzing content and generating topic name...';
    
    try {
        // AI will auto-generate topic name - no user input needed
        const response = await fetch(`${API_BASE}/sources/${sourceId}/generate-topic`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({}) // Empty - AI will generate topic name
        });
        
        const data = await response.json();
        if (data.success) {
            // Update loading text to show success
            loadingIndicator.querySelector('.loading-text').textContent = `‚úÖ Successfully created topic with ${data.data.questions.length} questions!`;
            loadingIndicator.classList.add('success');
            
            // Reload sources after a brief delay
            setTimeout(() => {
                loadSources();
            }, 1500);
        } else {
            // Show error
            loadingIndicator.querySelector('.loading-text').textContent = `‚ùå Error: ${data.error}`;
            loadingIndicator.classList.add('error');
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Topic & Questions';
            
            // Hide error after 5 seconds
            setTimeout(() => {
                loadingIndicator.style.display = 'none';
                loadingIndicator.classList.remove('error');
            }, 5000);
        }
    } catch (error) {
        // Show error
        loadingIndicator.querySelector('.loading-text').textContent = `‚ùå Error: ${error.message}`;
        loadingIndicator.classList.add('error');
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Topic & Questions';
        
        // Hide error after 5 seconds
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
            loadingIndicator.classList.remove('error');
        }, 5000);
    } finally {
        // Remove generating class
        sourceItem.classList.remove('generating');
    }
}

async function viewTopics(sourceId) {
    try {
        const response = await fetch(`${API_BASE}/sources/${sourceId}/topics`);
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
            const topicsHtml = data.data.map(topic => `
                <div class="topic-item">
                    <h4>${topic.title}</h4>
                    <p>${topic.questions.length} questions</p>
                    <button onclick="createQuizFromTopic(${topic.id})" class="btn btn-primary">Create Quiz</button>
                </div>
            `).join('');
            
            alert('Topics:\n\n' + topicsHtml.replace(/<[^>]*>/g, ''));
        } else {
            alert('No topics found for this source. Generate one first!');
        }
    } catch (error) {
        alert('Error loading topics: ' + error.message);
    }
}

function createQuizFromTopic(topicId) {
    window.location.href = `/quizzes?topic_id=${topicId}`;
}

async function deleteSource(sourceId) {
    if (!confirm('Are you sure you want to delete this source? This will also delete all associated topics and questions.')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/sources/${sourceId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Source deleted successfully!');
            loadSources();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete source'));
        }
    } catch (error) {
        console.error('Error deleting source:', error);
        alert('Error deleting source: ' + error.message);
    }
}

// Load sources on page load
loadSources();
</script>
{% endblock %}
{% endblock %}

